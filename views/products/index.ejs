<%- include('../partials/header') %>

<div class="container py-5">
    <!-- Search form -->
    <form action="/products" method="GET" class="mb-4">
        <div class="input-group">
            <input type="text" 
                   name="search" 
                   class="form-control" 
                   placeholder="Search products..."
                   value="<%= filters.search || '' %>"
                   aria-label="Search products">
            <button class="btn btn-primary" type="submit">
                <i class="bi bi-search"></i> Search
            </button>
        </div>
    </form>

    <!-- Add instant search results -->
    <div id="searchResults" class="position-absolute bg-white shadow-sm rounded p-2" style="display: none; z-index: 1000;">
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-3">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">Filters</h5>
                    <form action="/products" method="GET">
                        <!-- Preserve search query if exists -->
                        <% if (filters.search) { %>
                            <input type="hidden" name="search" value="<%= filters.search %>">
                        <% } %>

                        <!-- Categories -->
                        <div class="mb-3">
                            <label class="form-label">Categories</label>
                            <% categories.forEach(category => { %>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="category" value="<%= category._id %>"
                                           id="category<%= category._id %>"
                                           <%= (filters.category && (Array.isArray(filters.category) 
                                                ? filters.category.includes(category._id.toString()) 
                                                : filters.category === category._id.toString())) ? 'checked' : '' %>>
                                    <label class="form-check-label" for="category<%= category._id %>">
                                        <%= category.name %>
                                    </label>
                                </div>
                            <% }); %>
                        </div>

                        <!-- Brands -->
                        <div class="mb-3">
                            <label class="form-label">Brands</label>
                            <% brands.forEach(brand => { %>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="brand" value="<%= brand %>"
                                           id="brand<%= brand %>"
                                           <%= (filters.brand && (Array.isArray(filters.brand) 
                                                ? filters.brand.includes(brand) 
                                                : filters.brand === brand)) ? 'checked' : '' %>>
                                    <label class="form-check-label" for="brand<%= brand %>">
                                        <%= brand %>
                                    </label>
                                </div>
                            <% }); %>
                        </div>

                        <!-- Price Range -->
                        <div class="mb-3">
                            <label class="form-label">Price Range</label>
                            <div class="d-flex gap-2">
                                <input type="number" class="form-control" name="minPrice" 
                                       placeholder="Min" value="<%= filters.minPrice || '' %>">
                                <input type="number" class="form-control" name="maxPrice" 
                                       placeholder="Max" value="<%= filters.maxPrice || '' %>">
                            </div>
                        </div>

                        <!-- Sort -->
                        <div class="mb-3">
                            <label class="form-label">Sort By</label>
                            <select class="form-select" name="sort">
                                <option value="-createdAt" <%= filters.sort === '-createdAt' ? 'selected' : '' %>>Newest</option>
                                <option value="price" <%= filters.sort === 'price' ? 'selected' : '' %>>Price: Low to High</option>
                                <option value="-price" <%= filters.sort === '-price' ? 'selected' : '' %>>Price: High to Low</option>
                                <option value="name" <%= filters.sort === 'name' ? 'selected' : '' %>>Name: A to Z</option>
                                <option value="-name" <%= filters.sort === '-name' ? 'selected' : '' %>>Name: Z to A</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="col-lg-9">
            <% if (products.length > 0) { %>
                <!-- Show results count if there's a search -->
                <% if (filters.search) { %>
                    <p class="mb-4">Found <%= pagination.total %> results for "<%= filters.search %>"</p>
                <% } %>

                <div class="row row-cols-1 row-cols-md-3 g-4">
                    <% products.forEach(product => { %>
                        <div class="col">
                            <div class="card h-100">
                                <img src="<%= product.images[0]?.url || '/images/default-product.jpg' %>" 
                                     class="card-img-top" 
                                     alt="<%= product.name %>"
                                     style="height: 200px; object-fit: contain;">
                                <div class="card-body">
                                    <h5 class="card-title"><%= product.name %></h5>
                                    <p class="card-text text-muted mb-2"><%= product.brand %></p>
                                    <h6 class="mb-3">$<%= product.price.toFixed(2) %></h6>
                                    <a href="/products/<%= product._id %>" class="btn btn-primary w-100">View Details</a>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>

                <!-- Pagination -->
                <% if (pagination.pages > 1) { %>
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            <% for(let i = 1; i <= pagination.pages; i++) { %>
                                <li class="page-item <%= pagination.page === i ? 'active' : '' %>">
                                    <a class="page-link" href="<%= getPageUrl(i) %>"><%= i %></a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                <% } %>
            <% } else { %>
                <div class="text-center py-5">
                    <i class="bi bi-search display-1 text-muted mb-4"></i>
                    <h3>No products found</h3>
                    <% if (Object.keys(filters).length > 0) { %>
                        <p class="text-muted">Try adjusting your search or filter criteria</p>
                        <a href="/products" class="btn btn-outline-primary mt-3">Clear all filters</a>
                    <% } else { %>
                        <p class="text-muted">No products are available at the moment.</p>
                    <% } %>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
const searchInput = document.querySelector('input[name="search"]');
const searchResults = document.getElementById('searchResults');
let searchTimeout;

searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();

    if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
    }

    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/products/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data.products.length > 0) {
                searchResults.innerHTML = data.products.map(product => `
                    <div class="search-result-item p-2 border-bottom">
                        <a href="/products/${product._id}" class="text-decoration-none text-dark">
                            <div class="d-flex align-items-center">
                                <img src="${product.images[0]?.url || '/images/default-product.jpg'}" 
                                     alt="${product.name}" 
                                     class="me-2" 
                                     style="width: 40px; height: 40px; object-fit: cover;">
                                <div>
                                    <div>${product.name}</div>
                                    <small class="text-muted">$${product.price}</small>
                                </div>
                            </div>
                        </a>
                    </div>
                `).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        } catch (error) {
            console.error('Search error:', error);
        }
    }, 300);
});

// Hide search results when clicking outside
document.addEventListener('click', function(e) {
    if (!searchResults.contains(e.target) && e.target !== searchInput) {
        searchResults.style.display = 'none';
    }
});
</script>

<%- include('../partials/footer') %> 